# 项目健康检查清单

本文档记录了项目中已修复和需要注意的问题。

## ✅ 已修复的问题

### 1. 日志系统优化 (2025-12-26)

**问题描述**:
- 项目中存在 81 个 console 日志，分布在 20 个文件中
- 日志过于冗余，影响开发调试体验
- 缺乏统一的日志管理机制

**解决方案**:
- ✅ 创建了专业的分级日志系统 (`src/lib/logger.ts`)
- ✅ 支持 DEBUG、INFO、WARN、ERROR 四个日志级别
- ✅ 自动区分开发/生产环境
- ✅ 支持模块化标签和过滤
- ✅ 修复了以下文件的冗余日志问题:
  - `ECSProvider.tsx` - 订阅管理器日志优化
  - `Replay.ts` - Intent记录器日志优化
  - `PixiWebRenderer.ts` - 渲染器日志优化
  - `useECSResource.ts` - Hook日志优化
  - `MainMenu.tsx` - 组件日志优化

**使用文档**: 参见 `docs/LOGGING.md`

---

## 🔍 潜在问题分析

### 1. 订阅管理器 (ECSSubscriptionManager)

**位置**: `src/presentation/ui/bindings/ECSProvider.tsx`

**原问题**:
- ❌ 每次订阅/取消都打印日志
- ❌ notify 时打印每个订阅者
- ❌ 高频调用导致日志污染

**现状**:
- ✅ 已优化为 DEBUG 级别
- ✅ 合并了日志信息
- ✅ 添加了错误处理
- ⚠️ 注意: 生产环境会自动关闭这些日志

**建议**:
```typescript
// 如需调试订阅问题，使用:
configureLogger({
  minLevel: Level.DEBUG,
  moduleWhitelist: ['ECSSubscriptionManager'],
});
```

---

### 2. Intent 记录器 (IntentRecorder)

**位置**: `src/core/ecs/Replay.ts`

**原问题**:
- ❌ 每个 Intent 都打印日志
- ❌ 回放时打印每个 Intent
- ❌ 详细日志量过大

**现状**:
- ✅ 详细日志降级为 DEBUG
- ✅ 重要节点保留为 INFO (开始/结束)
- ✅ 添加了成功/失败计数
- ⚠️ 开发环境仍会显示详细日志

**建议**:
```typescript
// 如需关闭 IntentRecorder 日志:
configureLogger({
  moduleBlacklist: ['IntentRecorder'],
});
```

---

### 3. Pixi.js 渲染器 (PixiWebRenderer)

**位置**: `src/presentation/adapters/web/PixiWebRenderer.ts`

**原问题**:
- ❌ resize、start、stop 等操作都打印
- ❌ 调试信息过多

**现状**:
- ✅ 调试操作降级为 DEBUG
- ✅ 保留关键生命周期 INFO 日志
- ✅ 完善了错误处理

**建议**:
- 渲染器的 DEBUG 日志在生产环境自动关闭
- 如遇渲染问题，可临时开启调试

---

### 4. React Hooks 日志 (useECSResource)

**位置**: `src/presentation/ui/hooks/useECSResource.ts`

**原问题**:
- ❌ 每次获取资源都打印
- ❌ 高频调用导致日志刷屏

**现状**:
- ✅ 全部降级为 DEBUG
- ✅ 简化日志信息
- ⚠️ 可能需要进一步优化

**建议**:
```typescript
// 正常情况下应该屏蔽此模块:
configureLogger({
  moduleBlacklist: ['useECSResource'],
});
```

---

## 🎯 最佳实践建议

### 日志使用规范

1. **组件渲染日志**
   - ❌ 不要在每次渲染时打印日志
   - ✅ 只在关键状态变化时打印 INFO
   - ✅ 详细调试信息使用 DEBUG

2. **循环和高频代码**
   - ❌ 避免在游戏循环中打印日志
   - ❌ 避免在鼠标移动等高频事件中打印
   - ✅ 使用计数器降低日志频率

3. **错误处理**
   - ✅ 所有 catch 块都应该有 ERROR 日志
   - ✅ 错误日志应包含上下文信息
   - ✅ 使用 logger.error() 而不是 console.error()

### 项目结构建议

1. **模块化**
   - 每个主要模块都应该有自己的 logger
   - 使用清晰的模块名称
   - 避免使用通用名称如 "utils"

2. **配置管理**
   - 在 `src/app/GameApp.tsx` 中配置全局日志
   - 开发时使用 URL 参数控制调试模式
   - 生产环境自动优化

3. **文档维护**
   - 重大变更更新此文档
   - 记录已知问题和解决方案
   - 提供调试技巧

---

## 📋 检查清单

使用此清单定期检查项目健康状态:

### 代码质量
- [ ] 没有 console.log/warn/error (应使用 logger)
- [ ] 所有错误都有适当的日志
- [ ] 没有在循环中打印日志
- [ ] 组件不会在每次渲染时打印日志

### 性能
- [ ] 生产构建大小合理
- [ ] 没有不必要的依赖
- [ ] 日志在生产环境自动优化
- [ ] 没有内存泄漏

### 测试
- [ ] 所有测试通过
- [ ] 关键功能有测试覆盖
- [ ] 没有被忽略的测试

### 文档
- [ ] README 更新
- [ ] API 文档完整
- [ ] 变更日志维护
- [ ] 此文档保持最新

---

## 🐛 已知问题

### 1. 测试文件日志
**位置**: `src/core/ecs/EventSystem.test.ts`, `Replay.test.ts`

**状态**: 待处理

**说明**: 测试文件中仍使用 console.log，这是可以接受的

**优先级**: 低

---

### 2. 其他系统文件日志
**位置**:
- `src/gameplay/systems/*.ts`
- `src/gameplay/utils/*.ts`

**状态**: 待优化

**说明**: 这些文件的日志暂未迁移到新系统

**优先级**: 中

**计划**: 根据需要逐步迁移

---

## 📊 统计信息

### 日志系统迁移进度

| 模块 | 状态 | 优先级 |
|------|------|--------|
| ECS 核心 | ✅ 完成 | 高 |
| Pixi 渲染器 | ✅ 完成 | 高 |
| React 绑定 | ✅ 完成 | 高 |
| UI 组件 | 🔄 部分完成 | 中 |
| 游戏系统 | ⏳ 待处理 | 中 |
| 工具函数 | ⏳ 待处理 | 低 |
| 测试文件 | ⏳ 待处理 | 低 |

**总体进度**: 约 60%

---

## 🔄 维护历史

### 2025-12-26
- 创建专业日志系统
- 优化核心模块日志
- 编写使用文档
- 创建配置示例

---

## 📝 下一步计划

1. [ ] 逐步迁移剩余的游戏系统日志
2. [ ] 添加性能监控日志
3. [ ] 实现日志导出功能（用于bug报告）
4. [ ] 添加日志过滤UI（开发工具）
5. [ ] 优化生产环境日志收集

---

## 💡 贡献指南

当你发现新问题或修复问题时:

1. 在此文档中记录问题
2. 实施修复方案
3. 更新状态为"已修复"
4. 添加使用建议
5. 更新统计信息

保持此文档为项目健康检查的中心参考！
